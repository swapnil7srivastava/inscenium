# Inscenium CI/CD Pipeline
# GitHub Actions workflow for automated testing, building, and deployment

name: Inscenium CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run nightly tests at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHONPATH: .
  MOCK_ML_MODELS: true
  INSCENIUM_TEST_MODE: true
  CUDA_VISIBLE_DEVICES: ""  # Disable GPU in CI

jobs:
  # ============================================================================
  # Code Quality and Linting
  # ============================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pypoetry
        key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install Poetry
      run: |
        pip install poetry
        poetry config virtualenvs.in-project true
        
    - name: Install Python dependencies
      run: |
        poetry install --with dev
        
    - name: Run Python linting
      run: |
        source .venv/bin/activate
        ruff check .
        black --check .
        isort --check-only .
        
    - name: Run type checking
      run: |
        source .venv/bin/activate
        mypy perception/ sgi/ render/ measure/ --install-types --non-interactive || true
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'control/cms/webapp/pnpm-lock.yaml'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install CMS dependencies
      run: |
        cd control/cms/webapp
        pnpm install
        
    - name: Run TypeScript linting
      run: |
        cd control/cms/webapp
        pnpm lint
        pnpm prettier --check .
        
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
        
    - name: Run Go linting
      run: |
        cd control/api
        gofmt -l .
        go vet ./...
        
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
        
    - name: Run Rust linting
      run: |
        cd edge
        cargo fmt --check
        cargo clippy --all-targets --all-features -- -D warnings
        
    - name: Shellcheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './ops/scripts'

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Bandit (Python security)
      run: |
        pip install bandit
        bandit -r perception/ sgi/ render/ measure/ -f json -o bandit-report.json || true
        
    - name: Run Safety (Python dependencies)
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
        
    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/python
          p/golang
          p/rust
          p/typescript
          p/docker
          
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # ============================================================================
  # Python Testing
  # ============================================================================
  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
        
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: inscenium
          POSTGRES_USER: inscenium
          POSTGRES_DB: inscenium
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pypoetry
        key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install Poetry and dependencies
      run: |
        pip install poetry
        poetry config virtualenvs.in-project true
        poetry install --with dev
        
    - name: Set up database schema
      env:
        POSTGRES_DSN: postgresql://inscenium:inscenium@localhost:5432/inscenium
      run: |
        source .venv/bin/activate
        psql $POSTGRES_DSN -f sgi/sgi_schema.sql || echo "Schema file not found, using basic setup"
        
    - name: Run Python tests
      env:
        POSTGRES_DSN: postgresql://inscenium:inscenium@localhost:5432/inscenium
        PYTHONPATH: .
        MOCK_ML_MODELS: true
      run: |
        source .venv/bin/activate
        python -m pytest tests/ \
          --cov=perception --cov=sgi --cov=render --cov=measure \
          --cov-report=xml --cov-report=term \
          --junitxml=pytest-results.xml \
          -v
          
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: python-test-results-${{ matrix.python-version }}
        path: |
          pytest-results.xml
          coverage.xml
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: python
        name: python-${{ matrix.python-version }}

  # ============================================================================
  # Go Testing
  # ============================================================================
  test-go:
    name: Go Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: go-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
        
    - name: Download dependencies
      run: |
        cd control/api
        go mod download
        
    - name: Run Go tests
      run: |
        cd control/api
        go test -v -race -coverprofile=coverage.out ./...
        
    - name: Upload Go coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./control/api/coverage.out
        flags: golang
        name: golang

  # ============================================================================
  # Rust Testing
  # ============================================================================
  test-rust:
    name: Rust Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: wasm32-unknown-unknown
        
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          edge/target
        key: rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run Rust tests
      run: |
        cd edge
        cargo test --verbose
        
    - name: Build WASM
      run: |
        cd edge/edge_worker_wasm
        cargo build --target wasm32-unknown-unknown --release

  # ============================================================================
  # TypeScript/Node.js Testing
  # ============================================================================
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'control/cms/webapp/pnpm-lock.yaml'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install dependencies
      run: |
        cd control/cms/webapp
        pnpm install
        
    - name: Run TypeScript checks
      run: |
        cd control/cms/webapp
        pnpm type-check || echo "Type checking not configured"
        
    - name: Build frontend
      run: |
        cd control/cms/webapp
        pnpm build
        
    - name: Run frontend tests
      run: |
        cd control/cms/webapp
        pnpm test || echo "Tests not configured"

  # ============================================================================
  # Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-go, test-rust]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: inscenium
          POSTGRES_USER: inscenium
          POSTGRES_DB: inscenium
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        pip install poetry
        poetry config virtualenvs.in-project true
        poetry install --with dev
        
    - name: Run golden scene tests
      env:
        POSTGRES_DSN: postgresql://inscenium:inscenium@localhost:5432/inscenium
        REDIS_URL: redis://localhost:6379/0
        PYTHONPATH: .
        MOCK_ML_MODELS: true
      run: |
        source .venv/bin/activate
        python -m pytest tests/test_acceptance_quality.py -v

  # ============================================================================
  # Docker Build
  # ============================================================================
  build-docker:
    name: Docker Build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push API image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ops/docker/Dockerfile.api
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/api:latest
          ghcr.io/${{ github.repository }}/api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push worker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ops/docker/Dockerfile.worker
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/worker:latest
          ghcr.io/${{ github.repository }}/worker:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ============================================================================
  # Performance Testing
  # ============================================================================
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install poetry
        poetry config virtualenvs.in-project true
        poetry install --with dev
        
    - name: Run performance benchmarks
      run: |
        source .venv/bin/activate
        python -m pytest tests/benchmarks/ -v --benchmark-only
        
    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: |
          benchmark-results.json

  # ============================================================================
  # Notification
  # ============================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [lint, security, test-python, test-go, test-rust, test-frontend, test-integration]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.lint.result == 'success' && needs.security.result == 'success' && needs.test-python.result == 'success' && needs.test-go.result == 'success' && needs.test-rust.result == 'success' && needs.test-frontend.result == 'success' && needs.test-integration.result == 'success'
      run: echo "✅ All checks passed!"
      
    - name: Notify failure
      if: contains(needs.*.result, 'failure')
      run: |
        echo "❌ Some checks failed!"
        exit 1