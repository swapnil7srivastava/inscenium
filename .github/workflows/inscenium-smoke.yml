name: Inscenium Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: macos-latest
    env:
      INS_LOG_FORMAT: plain
      CI: true
      INS_FORCE_CPU: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Install Poetry reliably (donâ€™t rely on whatever the image ships)
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      # Cache Poetry downloads and the project venv to speed up runs
      - name: Cache Poetry downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-pypoetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-pypoetry-

      - name: Cache project venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-py311-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-venv-py311-

      # Install exactly what poetry.lock says; do NOT run `poetry lock`
      - name: Install deps from lockfile (and the project)
        run: |
          poetry --version
          poetry install --no-interaction --sync

      # Your script creates/refreshes .venv-runtime and validates core wheels
      - name: Prepare slim runtime (torch CPU etc.)
        run: |
          chmod +x fix_inscenium_env.sh
          ./fix_inscenium_env.sh

      # Quick CLI checks so we fail fast if the entrypoint breaks
      - name: CLI sanity
        run: |
          poetry run inscenium --help > /dev/null
          poetry run inscenium video --help > /dev/null

      # Your Makefile smoke target now passes (no heredoc issues)
      - name: Run smoke
        run: make smoke

      # Optional: run a minimal CLI invocation (no sample video dependence)
      # Keeps CI quick; if you want to render a demo later, add that step here.
      - name: Minimal CLI run (no I/O)
        run: |
          poetry run inscenium --version || true

      # Upload whatever artifacts were produced; ignore if not present
      - name: Upload smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: inscenium-smoke
          path: |
            runs/*/overlay.mp4
            runs/*/report.html
            runs/*/metrics.json
            runs/*/events.sgi.jsonl
            runs/**/smoke_versions.txt
          if-no-files-found: ignore
